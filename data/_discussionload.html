<script>
	function ds_request(verb, url, func, body) {
		/**
		 * Make an xhr request using the given verb, url and function
		 */
		
		let xhr = new XMLHttpRequest();
		xhr.onreadystatechange = func;
		xhr.open(verb, url, true);
		xhr.send(body);
	}
	
	function escape_string(string) {
		// letting the browser do this for us
		// http://stackoverflow.com/questions/3043775
		let p = document.createElement("p");
		p.appendChild(document.createTextNode(string));
		return p.innerHTML;
	}
	
	function format_time(t) {
		let d = new Date(t * 1000);
		
		return d.getUTCFullYear() + "-" + d.getUTCMonth() + "-" + d.getUTCDate() + " " + d.getUTCHours() + ":" + d.getUTCMinutes();
	}
	
	function ds_render_actions(actions, index) {
		let string = "<p>";
		
		// Render each action
		for (let i = 0; i < actions.length; i++) {
			switch (actions[i]) {
				case "hide": {
					string += "<a href=\"./?a=discussion_hide&id=" + DiscussionID + "&index=" + index + "&after=" + window.location + "&key=" + UserSAK + "\"><span class=\"material-icons\" style=\"position: relative; top: 5px; margin-right: 3px;\">block</span> Hide</a>";
					break;
				}
				default: {
					break;
				}
			}
		}
		
		return string + "</p>";
	}
	
	function ds_render_comment(image, author, display, time, body, actions, index) {
		return "<div class=\"comment-card\"><div class=\"comment-card-inner\"><div class=\"comment-card-inner-left\"><img src=\"" + image + "\"/></div><div class=\"comment-card-inner-right\"><p><a href=\"./?u=" + author + "\">" + display + "</a> <span class=\"small-text\">(@" + author + " | " + time + ")</span></p><p>" + body + "</p>" + ds_render_actions(actions, index) + "</div></div></div>";
	}
	
	function ds_load_handle() {
		if (this.readyState != 4) {
			return;
		}
		
		let discussion = document.getElementById("discussion-" + DiscussionID);
		let data = JSON.parse(this.responseText);
		
		switch (this.status) {
			case 200: {
				discussion.innerHTML = "";
				
				for (let i = 0; i < data["comments"].length; i++) {
					let comment = data["comments"][(DiscussionBackwards ? (data["comments"].length - i - 1) : i)];
					let image = escape_string(comment["image"]);
					let author = escape_string(comment["author"]);
					let display = escape_string(comment["display"]);
					let body = comment["body"]; // Will already be escaped
					let date = format_time(comment["updated"]);
					
					discussion.innerHTML += ds_render_comment(image, author, display, date, body, comment["actions"], comment["index"]);
				}
				
				break;
			}
			default:
				discussion.innerHTML = "<p><i>Error loading comments</i></p>";
				break;
		}
	}
	
	function ds_load() {
		ds_request("GET", "./?a=discussion_poll&id=" + DiscussionID + "&index=0", ds_load_handle);
	}
	
	function ds_clear() {
		let discussion = document.getElementById("discussion-" + DiscussionID);
		discussion.innerHTML = "<p style=\"text-align: center;\"><i>Discussions are loading...</i></p>";
	}
	
	function ds_update_handle() {
		if (this.readyState != 4) {
			return;
		}
		
		if (this.stauts == 200) {
			let entry = document.getElementById("discussions-" + DiscussionID + "-entry");
			entry.value = "";
			console.log("Submitted comment!");
		}
		else {
			let entry = document.getElementById("discussions-" + DiscussionID + "-error");
			entry.innerHTML = "<i>Sorry, there was an error submitting your comment. Please try again. (Status " + typeof(this.status) + " " + this.status + ")</i>";
		}
		
		setTimeout(ds_load, 1);
	}
	
	function ds_update() {
		let body = document.getElementById("discussions-" + DiscussionID + "-entry").value;
		ds_request("POST", "./?a=discussion_update&id=" + DiscussionID + "&index=-1&key=" + UserSAK + "&api=1", ds_update_handle, body);
	}
</script>
<p><button class="button secondary" onclick="ds_clear(); ds_load();">Reload discussions</button></p>
